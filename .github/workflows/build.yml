name: Gatsby build

on:
  push:
    branches:
      - master

jobs:
  build:
    name: Build, Deploy, Slack notify
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v1
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v1
        with:
          node-version: ${{ matrix.node-version }}
      # chache node_modules
      - name: Cache multiple paths
        uses: actions/cache@v2
        id: node_module_cache
        with: 
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      # Install Package
      - name: npm install
        run: |
          cd blog
          npm ci
      # Run build
      - name: npm build
        run: |
          cd blog/
          npm run build --if-present
      # Archive Production Artifact
      - name: Archive Production Artifact
        uses: actions/upload-artifact@master
        with:
          name: public
          path: blog/public
      # SSHキーのインストール
      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2.0.1
        with:
          key: ${{ secrets.SSH_KEY }}
          known_hosts: ${{ secrets.KNOWN_HOSTS }}
      # rsyncの実行
      - name: rsync
        run: rsync -auvz --delete blog/public/ ${{ secrets.REMOTE_USER }}@psbss.mixh.jp:./www/ue-y.me/blog/
      # Slack notify
      - name: Slack Incoming Webhook
        if: success()
        uses: tokorom/action-slack-incoming-webhook@v1.1.3
        env:
          INCOMING_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          blocks: |
            [
              {
                "type": "section",
                "text": {
                  "type": "plain_text",
                  "text": "ブログの更新が完了したよ！",
                  "emoji": true
                }
              },
              {
                "type": "divider"
              },
              {
                "type": "context",
                "elements": [
                  {
                    "type": "image",
                    "image_url": "${{ github.event.sender.avatar_url }}",
                    "alt_text": "github avatar"
                  },
                  {
                    "type": "mrkdwn",
                    "text": ": ${{ github.actor }}"
                  }
                ]
              },
              {
                "type": "context",
                "elements": [
                  {
                    "type": "plain_text",
                    "text": "Commit Message :",
                    "emoji": true
                  },
                  {
                    "type": "mrkdwn",
                    "text": "${{ env.COMMIT_MESSAGE }}"
                  }
                ]
              },
              {
                "type": "context",
                "elements": [
                  {
                    "type": "plain_text",
                    "text": "GitHub Actions URL :"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "${{ github.event.repository.url }}/actions/runs/${{ github.run_id }}"
                  }
                ]
              },
              {
                "type": "context",
                "elements": [
                  {
                    "type": "mrkdwn",
                    "text": "Blog URL :"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "https://blog.ue-y.me/"
                  }
                ]
              }
            ]
